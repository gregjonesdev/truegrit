{% extends '_timekeeperbase.html' %}

{% block timekeeper_content %}
<div class="row">
<div class="col-2">
    <div class="container mt-2" >
        <div class="dropdown dropdown-component" style="text-align: center">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                {{ friendly_date }}
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dateDropdown">
                <!-- Dates will be populated here -->
            </ul>
        </div>
    </div>
</div>
<div class="col-9">
    <div style="display: flex; flex-direction: row">
        {% if projects|length > 0 %}
            {% for each in projects %}
            <div class="card" style="width: 18rem; margin:5px">
            <div class="card-body">
                <h5 class="card-title">{{ each.project.get_title }}</h5>
        
                <div class="card-text">
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th scope="col">Start</th>
                            <th scope="col">End</th>
                            <th scope="col">Hours</th>
                            <th scope="col"></th>
                        </tr>
                        </thead>
                        <tbody>
                            {% for entry in each.time_entries %}
                                <tr>
                                    <td id="{{entry.uuid}}-start">{{ entry.start_time|date:"H:i"  }}</td>
                                    <td id="{{entry.uuid}}-end">{{ entry.end_time|date:"H:i" }}</td>
                                    <td>{{ entry.get_duration }}</td>
                                    <td style="padding: 0px; text-align: center">
                                        <button 
                                            class="btn btn-sm btn-outline-seconday editButton" 
                                            style="margin: 0px; padding: 0px"
                                            data-timeentry="{{ entry.uuid }}">
                                        <i class="fas fa-edit edit-icon"></i>
                                    </button></td>
                                </tr>
                                <p>{{ each.uuid }}</p>
                            {% endfor %}
                            <tr>
                                <th scope="col" colspan="2">Total</th>
                                <th scope="col">{{ each.daily_hours }}</th>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    <a href="{% url 'project_detail' each.project.uuid %}?date={{each.date}}" class="btn btn-secondary btn-sm">Details</a>
            </div>
            </div>    
        {% endfor %}
        {% else %}
        <div class="mt-2" style="padding-top: 6px;"><h5>No time entries today</h5></div>
        {% endif %}
    </div>
</div>
</div>
<div class="modal" id="editTimeEntryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Time Entry</h5>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id= "saveChanges" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>



<script>
    function formatDateForUrl(date) {
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-indexed
    var day = date.getDate().toString().padStart(2, '0'); // Pad the day with leading zero if needed
    return `${year}-${month}-${day}`;
}

// Function to format the date into "Thursday, 12/18" for display
function formatDateForDisplay(date) {
    var options = { weekday: 'long', month: '2-digit', day: '2-digit' };
    return date.toLocaleDateString('en-US', options); // This formats the date like "Thursday, 12/18"
}

function getLastFiveDays() {
    let days = [];
    let today = new Date();
    
    for (let i = 0; i < 6; i++) {
        let date = new Date(today);
        date.setDate(today.getDate() - i);
        days.push(date);
    }
    return days;
}


editButtons = document.getElementsByClassName('editButton')

for (let i=0; i<editButtons.length; i++) {
    editButtons[i].addEventListener("click", function (e){
        id = e.currentTarget.getAttribute("data-timeentry")
 
        $.ajax({
            url: '/edit-time-entry/' + id + '/',  // Your Django edit-timeentry URL
            type: 'GET',
            data: {
                id: id  // Passing the UUID as a GET parameter
            },
          
            success: function(response) {
                // Insert the modal content into the modal body
                $('#modalBody').html(response);

                // Show the modal
                $('#editTimeEntryModal').modal('show');
            },
            error: function(xhr, status, error) {
                alert('Error loading modal content');
            }
        });


    })
}
// Access the container where you want to append the list items
let dateDropdown = document.getElementById('dateDropdown');

// Iterate over the lastFiveDays array
lastFiveDays = getLastFiveDays()

lastFiveDays.forEach(function(day) {
    // Get the formatted date for the URL (YYYY-MM-DD)
    let formattedDateForUrl = formatDateForUrl(day);
    
    // Get the formatted date for display (Thursday, 12/18)
    let formattedDateForDisplay = formatDateForDisplay(day);
    
    // Create a new list item for each date
    let listItem = document.createElement('li');
    
    // Insert the link with the dynamically generated date for URL and display
    listItem.innerHTML = `<a class="dropdown-item" href="{% url 'dailytime' %}?date=${formattedDateForUrl}">${formattedDateForDisplay}</a>`;
    
    // Append the list item to the dropdown menu
 
    if ((formattedDateForDisplay != "{{ target_date }}") && (dateDropdown.children.length < 5)) {
        dateDropdown.appendChild(listItem);
    }
    
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
{% endblock timekeeper_content %}